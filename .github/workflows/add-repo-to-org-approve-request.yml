name: Add Repo To Org - Approve Request

on:
  issue_comment:
    types: [created]

env:
  APPROVER-GROUP: "issue-ops-approvers"
  ISSUE_TEMPLATE_NAME: "add-repo-to-org.yml"

jobs:
  approve:
    name: Add Repo To Org - Approve Request
    runs-on: ubuntu-latest
    
    # This job should only be run when the following conditions are true:
    #
    # - A user comments `.approve` on the issue.
    # - The issue has the `add-repo-to-org` label.
    # - The issue has the `validated` label.
    # - The issue has the `submitted` label.
    # - The issue does not have the `approved` or `denied` labels.
    # - The issue is open.
    if: github.event.comment.body != ''
      && startsWith(github.event.comment.body, '.approve')
      && contains(github.event.issue.labels.*.name, 'add-repo-to-org')
      && contains(github.event.issue.labels.*.name, 'validated')
      && contains(github.event.issue.labels.*.name, 'submitted')
      && !contains(github.event.issue.labels.*.name, 'approved')
      && !contains(github.event.issue.labels.*.name, 'denied')
      && github.event.issue.state == 'open'
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # Set up Node.js for issue-ops actions (parser and validator)
      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Get GitHub App Token
        id: token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.ISSUEOPSBOT_APP_ID }}
          private-key: ${{ secrets.ISSUEOPSBOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          permission-contents: write                        #Used to create development branch
          permission-issues: write                          #Used to parse the issue body, Assign Issue to Commenter, write comments and close the issue
          permission-administration: write                  #Used to create the new repo & verify it was created and set visibility to Internal
          permission-members: read                          #Used to verify commentor is a member of the Approver Team
          permission-repository-custom-properties: write    #Used to enable build check custom property

      - name: Parse Issue Body
        id: parse
        uses: issue-ops/parser@v5
        with:
          body: ${{ github.event.issue.body }}
          issue-form-template: ${{ env.ISSUE_TEMPLATE_NAME }}
          workspace: ${{ github.workspace }}

      - name: Verify Approver Is Not The Requestor
        id: verify-not-requester
        uses: lee-lott-actions/verify-approver-not-requester@v1
        with:
          requester: ${{ github.event.issue.user.login }}
          approver: ${{ github.event.comment.user.login }}

      # Step to verify comment author is a member of the issueops approver team.
      - name: Check IssueOps Approver Membership
        id: issueops-membership
        uses: lee-lott-actions/verify-team-membership@v1
        with:
          user: ${{ github.event.comment.user.login }}
          team-slug: ${{ env.APPROVER-GROUP }}
          token: ${{ steps.token.outputs.token }}
          owner: ${{ github.repository_owner }}

      # Step to assign issue to the comment author
      - name: Assign Issue to Commenter
        if: steps.verify-not-requester.outputs.is-approver-not-requester == 'true' && steps.issueops-membership.outputs.is-member == 'true'
        id: assign-issue
        uses: lee-lott-actions/assign-issue@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          assignee: ${{ github.event.comment.user.login }}
          token: ${{ steps.token.outputs.token }}
          owner: ${{ github.repository_owner }}
          repo-name: ${{ github.event.repository.name }}

      - name: Create Repository from Template
        if: steps.verify-not-requester.outputs.is-approver-not-requester == 'true'
          && steps.issueops-membership.outputs.is-member == 'true'
          && steps.assign-issue.outputs.result == 'success'
        id: create-repo
        uses: lee-lott-actions/add-repo-to-org@v1
        with:
          template-repo: ${{ fromJson(steps.parse.outputs.json)['template-repo'] }}
          repo-name: ${{ fromJson(steps.parse.outputs.json)['repo-name'] }}
          repo-description: ${{ fromJson(steps.parse.outputs.json)['repo-description'] }}
          owner: ${{ github.repository_owner }}
          token: ${{ steps.token.outputs.token }}
      
      - name: Wait for Repository Creation
        if: steps.create-repo.outputs.result == 'success'
        run: sleep 10
        shell: bash
          
      - name: Create Development Branch
        if: steps.create-repo.outputs.result == 'success'
        id: create-development-branch
        uses: lee-lott-actions/add-branch-to-repo@v1
        with: 
          repo-name: ${{ fromJson(steps.parse.outputs.json)['repo-name'] }}
          owner: ${{ github.repository_owner }}
          token: ${{ steps.token.outputs.token }}
          branch-name: 'development'
       
      - name: Update Repository Visibility to Internal
        if: steps.create-repo.outputs.result == 'success'
        id: update-repo-visibility
        uses: lee-lott-actions/update-repo-visibility@v1
        with:
          repo-name: ${{ fromJson(steps.parse.outputs.json)['repo-name'] }}
          owner: ${{ github.repository_owner }}
          token: ${{ steps.token.outputs.token }}
          visibility: 'public'      

      - name: Convert Template Status To Boolean
        id: convert-template-status
        run: |
          IS_TEMPLATE=$(echo "${{ fromJson(steps.parse.outputs.json)['is-template'][0] }}" | tr '[:upper:]' '[:lower:]')
          
          if [ "$IS_TEMPLATE" = "yes" ]; then
            echo "is-template=true" >> $GITHUB_OUTPUT
          elif [ "$IS_TEMPLATE" = "no" ]; then
            echo "is-template=false" >> $GITHUB_OUTPUT
          fi          

      - name: Set Repository To Template Status
        if: steps.create-repo.outputs.result == 'success'
        id: set-repo-template-status
        uses: lee-lott-actions/set-repo-template-status@v1
        with:
          repo-name: ${{ fromJson(steps.parse.outputs.json)['repo-name'] }}
          is-template: ${{ steps.convert-template-status.outputs.is-template }}
          owner: ${{ github.repository_owner }}
          token: ${{ steps.token.outputs.token }}          
       
      - name: Comment on Issue with Result
        if: always()
        id: create-message
        run: |

          if [ "${{ job.status }}" != "success" ]; then
            MESSAGE="❌ Failed to create repository. Check the workflow logs for details."
          elif [ "${{ steps.verify-not-requester.outputs.result }}" != "success" ]; then
            MESSAGE="❌ Failed to create repository. ${{ steps.verify-not-requester.outputs.error-message }}"
          elif [ "${{ steps.verify-not-requester.outputs.is-approver-not-requester }}" != "true" ]; then
            MESSAGE="❌ Failed to create repository. Approver cannot be the same person as the requester."
          elif [ "${{ steps.issueops-membership.outputs.result }}" != "success" ]; then
            MESSAGE="❌ Failed to create repository. ${{ steps.issueops-membership.outputs.error-message }}"
          elif [ "${{ steps.issueops-membership.outputs.is-member }}" != "true" ]; then
            MESSAGE="❌ Failed to create repository. Approver is not a member of the IssueOps Approvers team."
          elif [ "${{ steps.assign-issue.outputs.result }}" != "success" ]; then
            MESSAGE="❌ Failed to create repository. ${{ steps.assign-issue.outputs.error-message }}"
          elif [ "${{ steps.create-repo.outputs.result }}" != "success" ]; then
            MESSAGE="❌ Failed to create repository. ${{ steps.create-repo.outputs.error-message }}"            
          elif [ "${{ steps.create-development-branch.outputs.result }}" != "success" ]; then
            MESSAGE="❌ Failed to create repository. ${{ steps.create-development-branch.outputs.error-message }}"
          elif [ "${{ steps.update-repo-visibility.outputs.result }}" != "success" ]; then
            MESSAGE="❌ Failed to create repository. ${{ steps.update-repo-visibility.outputs.error-message }}"    
          elif [ "${{ steps.set-repo-template-status.outputs.result }}" != "success" ]; then
            MESSAGE="❌ Failed to create repository. ${{ steps.set-repo-template-status.outputs.error-message }}"            
          else
            MESSAGE="✅ Successfully created repository '${{ fromJson(steps.parse.outputs.json)['repo-name'] }}' from template '${{ github.repository_owner }}/${{ fromJson(steps.parse.outputs.json)['template-repo'] }}'."
          fi
          
          echo "comment=$MESSAGE" >> $GITHUB_OUTPUT
          
      - name: Post Comment        
        if: always()
        id: post-comment
        uses: lee-lott-actions/post-issue-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          message: ${{ steps.create-message.outputs.comment }}
          token: ${{ steps.token.outputs.token }}
          owner: ${{ github.repository_owner }}
          repo-name: ${{ github.event.repository.name }}     

      - name: Add Approved Label
        id: add-label
        if: >-
          success() &&
          steps.verify-not-requester.outputs.is-approver-not-requester == 'true' &&
          steps.issueops-membership.outputs.is-member == 'true' &&
          steps.assign-issue.outputs.result == 'success' &&
          steps.create-repo.outputs.result == 'success' &&
          steps.create-development-branch.outputs.result == 'success' &&
          steps.update-repo-visibility.outputs.result == 'success' &&
          steps.set-repo-template-status.outputs.result == 'success'
        uses: issue-ops/labeler@v4
        with:
          action: add
          github_token: ${{ steps.token.outputs.token }}
          labels: |
            approved
          issue_number: ${{ github.event.issue.number }}
          repository: ${{ github.repository }}

      - name: Close Issue
        if: >-
          success() &&
          steps.verify-not-requester.outputs.is-approver-not-requester == 'true' &&
          steps.issueops-membership.outputs.is-member == 'true' &&
          steps.assign-issue.outputs.result == 'success' &&
          steps.create-repo.outputs.result == 'success' &&
          steps.create-development-branch.outputs.result == 'success' &&
          steps.update-repo-visibility.outputs.result == 'success' &&
          steps.set-repo-template-status.outputs.result == 'success'
        uses: lee-lott-actions/close-issue@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          token: ${{ steps.token.outputs.token }}
          owner: ${{ github.repository_owner }}
          repo-name: ${{ github.event.repository.name }}        


  load-matrix:
      name: Load Matrix
      runs-on: ubuntu-latest
      needs: approve
      outputs:
        matrix_team: ${{ steps.import-matrix.outputs.matrix_team }}
        matrix_build: ${{ steps.import-matrix.outputs.matrix_build }}
      
      steps:
        - name: Checkout code
          uses: actions/checkout@v6

        - name: Get GitHub App Token
          id: token
          uses: actions/create-github-app-token@v2
          with:
            app-id: ${{ vars.ISSUEOPSBOT_APP_ID }}
            private-key: ${{ secrets.ISSUEOPSBOT_APP_PRIVATE_KEY }}
            owner: ${{ github.repository_owner }}
            permission-issues: write                          #Used to parse the issue body, Assign Issue to Commenter, write comments and close the issue
            permission-administration: write                  #Used to add the team to the repo
            permission-members: write                         #Used to verify commentor is a member of the Approver Team and create new team in org

        - name: Import Matrix
          id: import-matrix
          run: |
            file=".github/config/add-repo-to-org-approval.json"

            MATRIX_TEAM=$(jq -c '.team_matrix.team' "$file")
            MATRIX_BUILD=$(jq -c '.build_matrix.build' "$file")

            echo "matrix_team=$MATRIX_TEAM" >> "$GITHUB_OUTPUT"
            echo "matrix_build=$MATRIX_BUILD" >> "$GITHUB_OUTPUT"
            
            echo "Matrix Team: $MATRIX_TEAM"
            echo "Matrix Build: $MATRIX_BUILD"
            
  add-build-properties:
    needs: load-matrix
    if: ${{ needs.load-matrix.outputs.matrix_build != '[]' }}
    name: Add Custom Build Properties to New Repository
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include: ${{ fromJson(needs.load-matrix.outputs.matrix_build) }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # Set up Node.js for issue-ops actions (parser and validator)
      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Get GitHub App Token
        id: token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.ISSUEOPSBOT_APP_ID }}
          private-key: ${{ secrets.ISSUEOPSBOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          permission-issues: write                          #Used to parse the issue body, Assign Issue to Commenter, write comments and close the issue
          permission-administration: write                  #Used to add the team to the repo
          permission-members: write                         #Used to verify commentor is a member of the Approver Team and create new team in org
          permission-repository-custom-properties: write    #Used to enable build check custom property

      - name: Parse Issue Body
        id: parse
        uses: issue-ops/parser@v5
        with:
          body: ${{ github.event.issue.body }}
          issue-form-template: ${{ env.ISSUE_TEMPLATE_NAME }}
          workspace: ${{ github.workspace }}

      - name: Validate Repo Exists
        id: validate-repo
        uses: lee-lott-actions/verify-repo-exists@v1
        with:
          repo-name: ${{ fromJson(steps.parse.outputs.json)['repo-name'] }}
          token: ${{ steps.token.outputs.token }}
          owner: ${{ github.repository_owner }}   

      - name: Set Custom Property
        if: steps.validate-repo.outputs.repo-exists == 'true'
        id: set-custom-property
        uses: lee-lott-actions/update-repo-custom-property@v1
        with:
          repo-name: ${{ fromJson(steps.parse.outputs.json)['repo-name'] }}
          owner: ${{ github.repository_owner }}
          token: ${{ steps.token.outputs.token }}
          property-name: ${{ matrix.name }}
          property-value: ${{ matrix.value }}
          
  add-teams:
    needs: load-matrix
    if: ${{ needs.load-matrix.outputs.matrix_team != '[]'}}
    name: Add Teams With Permission to New Repository
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.load-matrix.outputs.matrix_team ) }}
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # Set up Node.js for issue-ops actions (parser and validator)
      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Get GitHub App Token
        id: token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.ISSUEOPSBOT_APP_ID }}
          private-key: ${{ secrets.ISSUEOPSBOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          permission-issues: write                          #Used to parse the issue body, Assign Issue to Commenter, write comments and close the issue
          permission-administration: write                  #Used to add the team to the repo
          permission-members: write                         #Used to verify commentor is a member of the Approver Team and create new team in org

      - name: Parse Issue Body
        id: parse
        uses: issue-ops/parser@v5
        with:
          body: ${{ github.event.issue.body }}
          issue-form-template: ${{ env.ISSUE_TEMPLATE_NAME }}
          workspace: ${{ github.workspace }}

      - name: Validate Repo Exists
        id: validate-repo
        uses: lee-lott-actions/verify-repo-exists@v1
        with:
          repo-name: ${{ fromJson(steps.parse.outputs.json)['repo-name'] }}
          token: ${{ steps.token.outputs.token }}
          owner: ${{ github.repository_owner }}   
        
      - name: Grant Team Access
        if: steps.validate-repo.outputs.repo-exists == 'true'
        id: add-team-to-repo
        uses: lee-lott-actions/add-team-to-repo@v1
        with:
          team-name: ${{ matrix.team }}
          role: ${{ matrix.role }}
          owner: ${{ github.repository_owner }}
          repo-name: ${{ fromJson(steps.parse.outputs.json)['repo-name'] }}
          token: ${{ steps.token.outputs.token }}
          
